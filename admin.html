
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      font-size: 16px;
    }
    input[type="number"] {
      width: 60px;
      font-size: 16px;
    }
    button {
      font-size: 16px;
      padding: 6px 12px;
      margin: 5px;
    }
  </style>
</head>
<body>
  <h2>Danmu Admin Panel</h2>

  <div>
    <label>Password: <input type="password" id="adminPassword" /></label>
    <button onclick="unlock()">Unlock</button>
  </div>

  <div id="controlPanel" style="display:none; margin-top:20px;">
    <h3>Custom Playback Tempo</h3>
    <div>
      <label>1st Phase: 
        <input type="number" id="firstDuration" value="20" /> min, 
        <input type="number" id="firstInterval" value="4" /> sec/line
      </label>
    </div>
    <div>
      <label>2nd Phase: 
        <input type="number" id="secondDuration" value="15" /> min, 
        <input type="number" id="secondInterval" value="2" /> sec/line
      </label>
    </div>
    <div>
      <label>3rd Phase: 
        <input type="number" id="thirdInterval" value="0.5" /> sec/line
      </label>
    </div>
    <button onclick="startSchedule()">Start</button>
    <button onclick="endSchedule()">End</button>

    <div style="margin-top:10px; font-size: 16px;" id="progressIndicator">
      ‚è±Ô∏è <span id="elapsedTime">Not started</span><br>
      üîÑ <span id="currentPhase">Phase: -</span>
    </div>
  </div>

  <script>
    const endpoint = "https://danmu-backend.onrender.com";
    let unlocked = false;
    let startTime = null;
    let scheduleTimer = null;
    let progressTimer = null;
    let firstDuration, secondDuration, firstInterval, secondInterval, thirdInterval;

    function unlock() {
      const password = document.getElementById("adminPassword").value;
      if (password.trim() !== "") {
        unlocked = true;
        document.getElementById("controlPanel").style.display = "block";
      }
    }

    function startSchedule() {
      if (!unlocked) return;
      firstDuration = parseFloat(document.getElementById("firstDuration").value);
      secondDuration = parseFloat(document.getElementById("secondDuration").value);
      firstInterval = parseFloat(document.getElementById("firstInterval").value);
      secondInterval = parseFloat(document.getElementById("secondInterval").value);
      thirdInterval = parseFloat(document.getElementById("thirdInterval").value);

      startTime = Date.now();

      if (scheduleTimer) clearInterval(scheduleTimer);
      scheduleTimer = setInterval(() => {
        const elapsed = (Date.now() - startTime) / 60000;
        let interval;
        if (elapsed < firstDuration) {
          interval = firstInterval;
        } else if (elapsed < firstDuration + secondDuration) {
          interval = secondInterval;
        } else {
          interval = thirdInterval;
        }
        fetch(endpoint + "/settings", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            password: document.getElementById("adminPassword").value,
            historyInterval: interval
          })
        });
      }, 3000);

      if (progressTimer) clearInterval(progressTimer);
      progressTimer = setInterval(updateProgress, 1000);
    }

    function endSchedule() {
      if (!unlocked) return;
      clearInterval(scheduleTimer);
      clearInterval(progressTimer);
      fetch(endpoint + "/settings", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          password: document.getElementById("adminPassword").value,
          historyInterval: 4
        })
      });
      document.getElementById("elapsedTime").innerText = "Stopped";
      document.getElementById("currentPhase").innerText = "Phase: -";
    }

    function formatTime(ms) {
      const totalSec = Math.floor(ms / 1000);
      const min = Math.floor(totalSec / 60);
      const sec = totalSec % 60;
      return `${min}m ${sec}s`;
    }

    function updateProgress() {
      const now = Date.now();
      const elapsedMs = now - startTime;
      document.getElementById("elapsedTime").innerText = "Running: " + formatTime(elapsedMs);
      const elapsedMin = elapsedMs / 60000;
      let phase = "";
      if (elapsedMin < firstDuration) {
        phase = `1st Phase (${firstInterval}s/Êù°)`;
      } else if (elapsedMin < firstDuration + secondDuration) {
        phase = `2nd Phase (${secondInterval}s/Êù°)`;
      } else {
        phase = `3rd Phase (${thirdInterval}s/Êù°)`;
      }
      document.getElementById("currentPhase").innerText = "Phase: " + phase;
    }
  </script>
</body>
</html>
