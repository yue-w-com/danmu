<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>弹幕展示（实时 + 历史）</title>
  <style>
    body { margin: 0; overflow: hidden; background: black; }
    .danmu {
      position: absolute;
      white-space: nowrap;
      animation-timing-function: linear;
      animation-fill-mode: forwards;
    }
  </style>
</head>
<body>
  <script>
    const socket = new WebSocket('wss://danmu-backend.onrender.com');
    const historyData = [];

    let TRACK_COUNT = parseInt(localStorage.getItem('danmu_tracks')) || 5;
    const SPEED = parseInt(localStorage.getItem('danmu_speed')) || 150;
    const FONT_SIZE = parseInt(localStorage.getItem('danmu_font_size')) || 24;

    const showDanmu = (text, color, useRandomTrack = false) => {
      const el = document.createElement('div');
      el.className = 'danmu';
      el.textContent = text;
      el.style.fontSize = FONT_SIZE + 'px';
      el.style.color = color || 'white';

      const trackHeight = window.innerHeight / TRACK_COUNT;
      const track = useRandomTrack
        ? Math.floor(Math.random() * TRACK_COUNT)
        : (showDanmu.trackIndex = (showDanmu.trackIndex + 1) % TRACK_COUNT);
      const topPosition = track * trackHeight;

      el.style.top = topPosition + 'px';
      el.style.right = '0';
      el.style.left = 'auto';

      document.body.appendChild(el);

      requestAnimationFrame(() => {
        const totalDistance = window.innerWidth + el.offsetWidth;
        const duration = totalDistance / SPEED;
        const animName = 'move_' + Math.random().toString(36).substr(2, 5);

        const style = document.createElement('style');
        style.innerHTML =
          '@keyframes ' + animName + ' {' +
          'from { transform: translateX(0); }' +
          'to { transform: translateX(-' + totalDistance + 'px); }' +
          '}';
        document.head.appendChild(style);

        el.style.animation = animName + ' ' + duration + 's linear forwards';
      });

      el.addEventListener('animationend', () => el.remove());
    };
    showDanmu.trackIndex = -1;

    const loopDanmu = () => {
      if (historyData.length > 0) {
        const d = historyData[Math.floor(Math.random() * historyData.length)];
        showDanmu(d.text, d.color, true);
      }
      setTimeout(loopDanmu, 4000);
    };

    fetch('https://danmu-backend.onrender.com/history')
      .then(res => res.json())
      .then(data => {
        if (Array.isArray(data)) {
          historyData.push(...data);
        }
        loopDanmu();
      })
      .catch(err => {
        console.error('获取历史弹幕失败:', err);
        loopDanmu();
      });

    socket.onmessage = async (e) => {
      try {
        const data = JSON.parse(await e.data.text());
        showDanmu(data.text, data.color, false);  // ✅ 立即展示
        historyData.push(data); // ✅ 追加用于循环
      } catch (err) {
        console.error('消息解析失败:', err);
      }
    };
  </script>
</body>
</html>
