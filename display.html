<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>弹幕展示（轨道+多色+精确消失）</title>
  <style>
    body { margin: 0; overflow: hidden; background: black; }
    .danmu {
      position: absolute;
      white-space: nowrap;
      font-size: 24px;
      animation-timing-function: linear;
      animation-fill-mode: forwards;
    }
  </style>
</head>
<body>
  <script>
    const socket = new WebSocket('wss://danmu-backend.onrender.com');
    const historyData = [];

    const TRACK_COUNT = 5;
    let currentTrack = 0;

    const COLORS = ['white', 'red', 'yellow', 'cyan', 'lime', 'orange', 'violet', 'deeppink'];

    const showDanmu = (text) => {
      const el = document.createElement('div');
      el.className = 'danmu';
      el.textContent = text;
      el.style.top = (currentTrack * (window.innerHeight / TRACK_COUNT)) + 'px';
      currentTrack = (currentTrack + 1) % TRACK_COUNT;

      el.style.right = '0';
      el.style.left = 'auto';
      el.style.color = COLORS[Math.floor(Math.random() * COLORS.length)];
      document.body.appendChild(el);

      // 等待 DOM 渲染以获取宽度
      requestAnimationFrame(() => {
        const distance = window.innerWidth + el.offsetWidth;
        const speed = 100; // 每秒 100 像素（可调）
        const duration = distance / speed;

        el.style.animation = `move ${duration}s linear forwards`;
        el.style.setProperty('--move-distance', distance + 'px');
      });

      // 创建动态 keyframes
      const styleSheet = document.styleSheets[0];
      if (![...styleSheet.cssRules].some(r => r.name === 'move')) {
        styleSheet.insertRule(\`
          @keyframes move {
            from { transform: translateX(0); }
            to { transform: translateX(calc(-1 * var(--move-distance))); }
          }
        \`, styleSheet.cssRules.length);
      }

      el.addEventListener('animationend', () => el.remove());
    };

    const loopDanmu = () => {
      if (historyData.length > 0) {
        const randomText = historyData[Math.floor(Math.random() * historyData.length)];
        showDanmu(randomText);
      }
      setTimeout(loopDanmu, 4000);
    };

    fetch('https://danmu-backend.onrender.com/history')
      .then(res => res.json())
      .then(data => {
        if (Array.isArray(data)) {
          data.forEach(d => {
            if (d.text) historyData.push(d.text);
          });
        }
        loopDanmu();
      })
      .catch(err => {
        console.error('获取历史弹幕失败:', err);
        loopDanmu();
      });

    socket.onmessage = async (e) => {
      const text = await e.data.text();
      showDanmu(text);
      historyData.push(text);
    };
  </script>
</body>
</html>
