<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>弹幕展示</title>
  <style>
    body { margin: 0; overflow: hidden; background: black; }
    .danmu {
      position: absolute;
      white-space: nowrap;
      font-size: 24px;
      color: white;
      animation: move 8s linear forwards;
    }
    @keyframes move {
      from { transform: translateX(100%); }
      to { transform: translateX(-100%); }
    }
  </style>
</head>
<body>
  <script>
    const socket = new WebSocket('wss://danmu-backend.onrender.com');

    const showDanmu = (text) => {
      const el = document.createElement('div');
      el.className = 'danmu';
      el.textContent = text;
      el.style.top = Math.random() * window.innerHeight + 'px';
      document.body.appendChild(el);
      el.addEventListener('animationend', () => el.remove());
    };

    let historyData = [];

    // 拉取历史弹幕数据
    fetch('https://danmu-backend.onrender.com/history')
      .then(res => res.json())
      .then(data => {
        historyData = data.map(d => d.text);

        // 循环随机弹幕
        setInterval(() => {
          if (historyData.length > 0) {
            const text = historyData[Math.floor(Math.random() * historyData.length)];
            showDanmu(text);
          }
        }, 2000); // 每2秒随机显示一个历史弹幕
      });

    // 接收新弹幕，处理 Blob 格式
    socket.onmessage = async (e) => {
      const text = await e.data.text();
      showDanmu(text);
      historyData.push(text); // 实时新弹幕也加入历史池
    };
  </script>
</body>
</html>
